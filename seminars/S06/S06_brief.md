# S06 - Secure Coding: one-liner + патчи + тесты

**Задача занятия (80 мин):**
зафиксировать **одну команду** для локальной сборки и тестов, применить **1-2 патча безопасности** к учебному проекту и оформить **4-6 автотестов**, сложив артефакты в `EVIDENCE/S06/`. Это базовая ступень перед контейнеризацией (S07) и CI (S08).

## Что получится к концу S06

* **One-liner** локального запуска сборки+тестов (без интерактива, повторяемый).
* **Исправлены 1-2 уязвимости** из карточек S06 (валидация/SQLi/XSS/авторизация/заголовки/ошибки и т. п.).
* **4-6 автотестов** (новых или доработанных), зелёные.
* **Артефакты/логи** в `EVIDENCE/S06/` и **заполненные пункты DV** в `GRADING/DV.md`.

## На что это закрывает DV

* **DV1 - Воспроизводимость**: one-liner + фиксация версий.
* **DV2 - Гигиена секретов**: не коммитим секреты, используем `.env.example`/плейсхолдеры.
* **DV3 - Минимальная безопасность кода**: применённые патчи и их проверяемость.
* **DV4 - Артефакты/логи**: собраны отчёты тестов, логи запуска.
* **DV5 - Инструкции**: краткое описание в `README` раздела «Локальный запуск».

## Предварительные требования

* Локально установлен ваш стек (Python/Node/Java - по проекту), менеджер пакетов, тестовый раннер.
* Клонирован шаблон `secdev-lite-template` (командный репозиторий студентов).

---

## План занятия (таймбокс)

**0-10 мин. Подготовка окружения**

1. Обновите зависимости/виртуальное окружение.
2. Убедитесь, что «голые» тесты стартуют (пусть даже падают).

**10-20 мин. Выбор карточек-патчей**
Откройте `S06_patch_cards.md`, выберите **минимум две** карточки под ваш код (например, «Валидация ввода + Экранирование вывода» или «Параметризация SQL + Проверка прав»).

**20-55 мин. Реализация патчей**
Примените фиксы. Не забудьте:

* фиксировать версии инструментов (requirements/lockfile);
* не коммитить секреты;
* оставить краткие комментарии «почему так».

**55-70 мин. Тесты**
Добавьте/обновите **4-6 тестов**, покрывающих исправленные сценарии (см. `S06_test_scenarios_template.md`). Добейтесь зелёного прогона.

**70-80 мин. Артефакты и DV**

1. Сложите отчёты/скриншоты/логи в `EVIDENCE/S06/`.
2. Заполните соответствующие пункты `GRADING/DV.md` (см. ниже «Что сдаём»).
3. Зафиксируйте **one-liner** (см. «One-liner»).

---

## One-liner (шаблон)

В `GRADING/DV.md` в разделе DV1 укажите **одну команду**, которая на чистой машине создаёт окружение, собирает/прогоняет тесты и пишет отчёт. Примеры формата:

```text
ТУТ НУЖНА ТВОЯ ВСТАВКА  # одна команда shell/powershell/make, без интерактива
```

Требования к one-liner:

* **Без интерактива** (никаких «press any key»/вводов паролей).
* **Детерминизм**: фиксируйте версии (requirements.txt, lock-файлы).
* **Отчёты**: тест-раннер пишет JUnit/текст в `EVIDENCE/S06/test-report.*`.
* **Коротко**: всё за один вызов (можно вызвать `make`/`npm run`/`tox` и т. п.).

---

## Что сдаём и куда складываем

В **репозитории команды (шаблон студентов)**:

* `GRADING/DV.md` - заполните:

  * **DV1:** ваш one-liner + примечания (ОС/версия языка).
  * **DV2:** где лежат примеры конфигов без секретов (`.env.example`, mock-ключи).
  * **DV3:** список применённых патчей (коротко: «что было → что сделали → где тест»).
  * **DV4:** перечень артефактов с путями (см. ниже).
  * **DV5:** 2-5 строк про локальный запуск в `README.md` (с ссылкой на one-liner).

* `EVIDENCE/S06/` - создайте и положите:

  * `test-report.(xml|txt|html)` - отчёт тестов;
  * `logs/` - логи выполнения one-liner (если есть);
  * `screenshots/` - скрины до/после (по уязвимостям, если релевантно);
  * `patches/` - диффы/фрагменты фиксов (опционально, если удобно).

Структура может быть расширена, но **пути должны совпадать** с теми, что указаны в `GRADING/DV.md`.

---

## Как выбирать патчи (быстрый ориентир)

Возьмите 1-2 пункта из `S06_patch_cards.md`:

* **Валидация/канонизация ввода** (строгие типы, длины, регэкспы, deny-/allow-list).
* **Параметризация SQL / ORM-плейсхолдеры** (никаких конкатенаций).
* **Экранирование вывода / шаблонов** (XSS-safe helpers).
* **Проверка прав** (разграничение действий, early-return при отсутствии прав).
* **Ошибки/логирование** (без утечки чувствительных данных в сообщения/трейсы).
* **Безопасные заголовки** (для веб-слоя: CSP, HSTS, X-Content-Type-Options и т. п.).

Каждый патч должен иметь **проверяемость тестом** (позитив/негатив).

---

## Критерии «готово»

**Минимум (★1, базовый):**

* One-liner работает на чистом окружении и даёт отчёт тестов.
* Исправлены ≥2 уязвимости из карточек; тесты зелёные.
* `EVIDENCE/S06/` содержит отчёты/логи; DV-пункты заполнены.

**Выше минимума (для себя):**

* Покрытие тестами растёт; добавлены негативные кейсы.
* Присутствуют короткие ADR-заметки «почему выбрали именно такой фикс».

---

## Частые ошибки

* One-liner требует ручного ввода или «ждёт» GUI.
* Секреты попадают в репозиторий (ключи, пароли).
* Тесты не проверяют уязвимость по сути (только «зелёный дым»).
* Артефакты не совпадают с путями, указанными в `GRADING/DV.md`.

---

## Связь с S07-S08

* **S07 (Containerization):** ваш one-liner станет `CMD`/entrypoint контейнера.
* **S08 (CI/CD Minimal):** тот же one-liner ляжет в job CI (build+test), а артефакты - в артефакты пайплайна.

---

## Шаблоны из этого семинара

* `S06_patch_cards.md` - набор типовых фиксов.
* `S06_secure_coding_checklist_template.md` - чек-лист исправлений.
* `S06_test_scenarios_template.md` - заготовка тест-кейсов.
* `S06_one_liner_template.md` - шаблон формулировки «одной команды».
