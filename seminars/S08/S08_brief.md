# S08 - CI Minimal (build + test → artifacts)

**Задача занятия (80 мин):**
включить CI на основе GitHub Actions, чтобы при `push/PR` автоматически выполнялись: **установка зависимостей → инициализация БД → pytest → выгрузка артефактов**. Затем обновить `DV.md` и README.

## Что получится к концу S08

* Рабочий **workflow** для Python 3.11 (или согласованной версии).
* **Зелёный ран** (или осмысленно красный, если тесты ещё красные - это тоже сигнал).
* **Артефакты CI** доступны для скачивания (JUnit-отчёт и др.) и/или зафиксированы индексом ссылок в `EVIDENCE/S08/`.
* **DV обновлён**:

  * **DV4** - артефакты/ссылки на ран(ы) CI.
  * **DV5** - краткая инструкция в README («как устроен CI»).
  * **DV2** - гигиена секретов в CI (ни один секрет не хранится в YAML/логе).

## Предварительные требования

* Репозиторий команды из **seed v2** (уже содержит `.github/workflows/ci.yml`).
* Доступ к **GitHub Actions** в репозитории (включено в Settings → Actions).
* Тесты из S06 доведены до состояния, позволяющего прогон в CI (как минимум запускаются).

---

## План занятия (таймбокс)

**0-10 мин. Подготовка**

1. Убедитесь, что файл `/.github/workflows/ci.yml` на месте.
2. Включите Actions (Settings → Actions → General → Allow all).
3. Сделайте любой коммит (`docs: enable ci`) - это запустит первый ран.

**10-25 мин. Первый прогон**

1. Откройте вкладку **Actions** и найдите запущенный ран.
2. Дождитесь завершения: проверьте шаги `Install deps`, `Init DB`, `pytest`, `Upload artifacts`.
3. Сохраните **URL рана** в `EVIDENCE/S08/ci-run.txt`.

**25-55 мин. Артефакты и проверяемость**

1. Из страницы рана скачайте артефакт (название вроде `evidence-s08`).
2. Положите в репозиторий **минимум один подтверждающий файл**:

   * `EVIDENCE/S08/test-report.xml` *(скачанный из артефактов)*,
   * или `EVIDENCE/S08/ci-log.txt` *(выписка из лога job)*,
   * или `EVIDENCE/S08/artifacts.txt` *(список файлов в артефакте)*.
3. Обновите `GRADING/DV.md` (см. «Что сдаём»).

**55-70 мин. Мини-улучшения CI (лайт)**
Выберите 1-2 пункта (необязательно, но полезно):

* **Cache pip** корректно работает (второй ран быстрее).
* **concurrency** (отмена старых ран на ту же ветку).
* **paths-ignore** (не запускать CI от правок только в `EVIDENCE/` или `README`).
* (Опц.) **coverage** → сохраните `coverage.xml` как артефакт.

**70-90 мин. Итоги**

* Добавьте в README 3-5 строк «Как устроен CI».
* Убедитесь, что `EVIDENCE/S08/*` заполнен (минимум `ci-run.txt` + один подтверждающий файл).
* Закоммитьте изменения.

---

## Что сдаём и куда складываем

В **репозитории команды**:

* `GRADING/DV.md` - допишите блок S08:

  * **DV4:** ссылку(и) на ран(ы) CI + перечисление артефактов (и где их скачать).
  * **DV5:** короткое описание пайплайна (этапы, когда триггерится, где смотреть логи/артефакты).
  * **DV2:** где лежат секреты для CI (GitHub Actions → Secrets/Variables), подтверждение, что в YAML/логах их нет.
* `EVIDENCE/S08/` - создайте и положите:

  * `ci-run.txt` - URL последнего удачного рана.
  * `test-report.xml` - скачанный JUnit-отчёт *(или)*
  * `ci-log.txt` - текстовая выписка ключевых шагов *(или)*
  * `artifacts.txt` - список файлов артефакта CI.
  * *(опц.)* `coverage.xml` или `coverage-html.zip`.

> Допускается хранить в репозитории **только индекс и ключевые выписки**, а сами артефакты - как **CI-артефакт** (Actions → Artifacts). Главное - дать проверяемые ссылки и минимум подтверждающих файлов в `EVIDENCE/S08/`.

---

## Базовый workflow (ориентир)

> В seed уже лежит минимальный `ci.yml`. Он должен включать шаги: checkout → setup-python → cache pip → install deps → init DB → pytest (с `--junitxml`) → upload artifact.

**Точки внимания (быстро проверить):**

* В pytest есть ключ:
  `--junitxml=EVIDENCE/S08/test-report.xml`
* Для артефактов стоит:

  ```yaml
  - name: Upload artifacts
    if: always()
    uses: actions/upload-artifact@v4
    with:
      name: evidence-s08
      path: EVIDENCE/S08/**
      if-no-files-found: warn
  ```

* Для кэша pip:

  ```yaml
  - uses: actions/cache@v4
    with:
      path: ~/.cache/pip
      key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
      restore-keys: ${{ runner.os }}-pip-
  ```

---

## Рекомендованные улучшения (по желанию)

* **concurrency:** отмена старых ранов по ветке, чтобы экономить время:

  ```yaml
  concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true
  ```

* **paths-ignore:** не гонять CI от изменений только документации/артефактов:

  ```yaml
  on:
    push:
      paths-ignore:
        - 'EVIDENCE/**'
        - 'README.md'
    pull_request:
      paths-ignore:
        - 'EVIDENCE/**'
        - 'README.md'
  ```

* **coverage:**
  `pytest --junitxml=... --cov=app --cov-report xml:coverage.xml`
  и загрузить `coverage.xml` как артефакт.

---

## Критерии «готово»

**Минимум (★1, базовый):**

* CI запускается на `push/PR`, выполняет install → init DB → pytest.
* Есть **один понятный пруф** в `EVIDENCE/S08/` (например, `ci-run.txt` + `test-report.xml`).
* `GRADING/DV.md` и README обновлены (DV2/DV4/DV5).

**Проектный уровень (★★2):**

* Настроен cache pip (второй ран заметно быстрее; отметка в DV).
* Включена `concurrency`/`paths-ignore`.
* Добавлено покрытие и/или матрица версий Python (по желанию).
* Секреты заведены как **Actions secrets/variables**; в логах/репозитории их нет.

---

## Частые ошибки

* Workflow не триггерится (Actions выключены / нет коммитов).
* Артефакт не загружается (неверный `path`/нет файлов).
* Жёстко закодированные секреты в YAML или утечка в лог.
* CI красный из-за тестов - это можно принять на S08, **если** в DV объяснено: «почему красный» и приложены артефакты/ссылки.

---

## Связь с S06-S07

* **S06:** ваши тесты + one-liner легли в основу шагов CI.
* **S07:** контейнеризацию можно подключить на следующем шаге (опционально построить образ в CI). Для «лайта» достаточно build+test без публикации образа.
